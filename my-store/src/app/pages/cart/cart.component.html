<!-- cart.component.html -->
<div class="container mt-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Page Headers -->
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Shopping Cart</h1>
        <div class="d-flex align-items-center gap-3">
          <span class="text-muted">{{ cartItems.length }} items</span>
          @if (cartItems.length > 0) {
            <button (click)="clearCart()" class="btn btn-outline-danger btn-sm">
              <i class="fas fa-trash me-1"></i> Clear Cart
            </button>
          }
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-8">
      @if (cartItems.length > 0) {
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-0">
            <!-- Table Header -->
            <div class="d-none d-md-flex p-3 bg-light border-bottom">
              <div class="col-md-5"><strong>Product</strong></div>
              <div class="col-md-2 text-center"><strong>Price</strong></div>
              <div class="col-md-2 text-center"><strong>Quantity</strong></div>
              <div class="col-md-2 text-center"><strong>Total</strong></div>
              <div class="col-md-1"></div>
            </div>

            <!-- Products -->
            @for (item of cartItems; track item.product.id) {
              <div class="p-3 border-bottom">
                <div class="row align-items-center">
                  <!-- Product Image -->
                  <div class="col-md-2 mb-3 mb-md-0">
                    <img [src]="item.product.image || 'assets/images/products/placeholder.jpg'" 
                         [alt]="item.product.name"
                         class="img-fluid rounded shadow-sm"
                         style="height: 120px; width: 120px; object-fit: cover;">
                  </div>

                  <!-- Product Information -->
                  <div class="col-md-3">
                    <h5 class="mb-1">
                      <a [routerLink]="['/products', item.product.id]" class="text-decoration-none text-dark">
                        {{ item.product.name }}
                      </a>
                    </h5>
                    <!-- Fixed: pass categoryId instead of the entire item -->
                    <p class="text-muted small mb-2">{{ getCategoryName(item.product.categoryId) }}</p>
                    
                    <!-- Colors and Sizes -->
                    @if (item.product.color || item.product.size) {
                      <div class="mt-2">
                        @if (item.product.color) {
                          <span class="badge bg-light text-dark me-2">
                            {{ item.product.color }}
                          </span>
                        }
                        @if (item.product.size) {
                          <span class="badge bg-light text-dark">
                            {{ item.product.size }}
                          </span>
                        }
                      </div>
                    }
                  </div>

                  <!-- Price -->
                  <div class="col-md-2 text-center">
                    <div class="mb-2">
                      <span class="h5 text-primary">{{ item.product.price | currency:'EGP ' }}</span>
                    </div>
                    @if (item.product.originalPrice && item.product.originalPrice > item.product.price) {
                      <div>
                        <small class="text-muted text-decoration-line-through">
                          {{ item.product.originalPrice | currency:'EGP ' }}
                        </small>
                        @if (item.product.discount) {
                          <span class="badge bg-danger ms-2">Save {{ item.product.discount }}%</span>
                        }
                      </div>
                    }
                  </div>

                  <!-- Quantity -->
                  <div class="col-md-2">
                    <div class="d-flex align-items-center justify-content-center">
                      <div class="input-group input-group-sm" style="width: 120px;">
                        <button class="btn btn-outline-secondary" 
                                (click)="updateQuantity(item, -1)"
                                [disabled]="item.quantity <= 1">
                          <i class="fas fa-minus"></i>
                        </button>
                        <input type="text" 
                               class="form-control text-center border-secondary" 
                               [value]="item.quantity"
                               readonly
                               style="min-width: 40px;">
                        <button class="btn btn-outline-secondary" 
                                (click)="updateQuantity(item, 1)"
                                [disabled]="item.product.stock && item.quantity >= item.product.stock">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Stock Warning -->
                    @if (item.product.stock !== undefined && item.product.stock > 0) {
                      @if (item.product.stock < 10) {
                        <small class="text-warning d-block mt-1">
                          <i class="fas fa-exclamation-triangle"></i> Only {{ item.product.stock }} left!
                        </small>
                      } @else {
                        <small class="text-success d-block mt-1">
                          <i class="fas fa-check-circle"></i> In Stock
                        </small>
                      }
                    }
                  </div>

                  <!-- Total -->
                  <div class="col-md-2 text-center">
                    <span class="h5 text-primary">
                      {{ (item.product.price * item.quantity) | currency:'EGP ' }}
                    </span>
                  </div>

                  <!-- Action Buttons -->
                  <div class="col-md-1 text-end">
                    <div class="dropdown">
                      <button class="btn btn-link text-muted" 
                              type="button" 
                              data-bs-toggle="dropdown"
                              aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                          <button class="dropdown-item" (click)="moveToWishlist(item)">
                            <i class="fas fa-heart text-danger me-2"></i>
                            Save to Wishlist
                          </button>
                        </li>
                        <li>
                          <button class="dropdown-item" (click)="saveForLater(item)">
                            <i class="fas fa-clock text-primary me-2"></i>
                            Save for Later
                          </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <button class="dropdown-item text-danger" (click)="removeItem(item)">
                            <i class="fas fa-trash me-2"></i>
                            Remove
                          </button>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Additional Buttons -->
        <div class="d-flex justify-content-between mb-4">
          <a routerLink="/products" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>
            Continue Shopping
          </a>
          
          <div class="d-flex gap-2">
            <button class="btn btn-primary" (click)="proceedToCheckout()">
              Proceed to Checkout
              <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

        <!-- Saved Items -->
        @if (getSavedItems().length > 0) {
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">Saved for Later ({{ getSavedItems().length }})</h5>
            </div>
            <div class="card-body">
              <div class="row">
                @for (product of getSavedItems(); track product.id) {
                  <div class="col-md-3 mb-3">
                    <div class="card h-100">
                      <img [src]="product.image || 'assets/images/products/placeholder.jpg'" 
                           class="card-img-top" 
                           [alt]="product.name"
                           style="height: 150px; object-fit: cover;">
                      <div class="card-body">
                        <h6 class="card-title">{{ product.name }}</h6>
                        <p class="card-text text-primary">{{ product.price | currency:'EGP ' }}</p>
                        <button (click)="addSavedToCart(product)" class="btn btn-sm btn-outline-primary w-100">
                          <i class="fas fa-cart-plus me-1"></i> Add to Cart
                        </button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      } @else {
        <!-- Empty Cart -->
        <div class="card border-0 shadow-sm text-center py-5">
          <div class="mb-4">
            <i class="fas fa-shopping-cart fa-4x text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">Your cart is empty</h3>
          <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet</p>
          
          <div class="d-flex justify-content-center gap-3">
            <a routerLink="/products" class="btn btn-primary btn-lg">
              <i class="fas fa-store me-2"></i>
              Start Shopping
            </a>
            @if (isAuthenticated) {
              <a routerLink="/wishlist" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-heart me-2"></i>
                View Wishlist
              </a>
            }
          </div>
        </div>
      }
    </div>

    <!-- Order Summary -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
        <div class="card-body">
          <h5 class="card-title mb-4">Order Summary</h5>
          
          <!-- Price Details -->
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal ({{ cartItems.length }} items)</span>
              <strong>{{ subtotal | currency:'EGP ' }}</strong>
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span>Shipping</span>
              @if (shipping === 0) {
                <span class="text-success">Free</span>
              } @else {
                <strong>{{ shipping | currency:'EGP ' }}</strong>
              }
            </div>
            
            <div class="d-flex justify-content-between mb-2">
              <span>Tax (14%)</span>
              <strong>{{ tax | currency:'EGP ' }}</strong>
            </div>
            
            @if (subtotal < 100) {
              <div class="alert alert-info small mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Add {{ (100 - subtotal) | currency:'EGP ' }} more for free shipping
              </div>
            } @else {
              <div class="alert alert-success small mb-3">
                <i class="fas fa-check-circle me-2"></i>
                You qualify for free shipping!
              </div>
            }
          </div>
          
          <!-- Total -->
          <div class="border-top pt-3 mb-4">
            <div class="d-flex justify-content-between">
              <strong class="h5">Total</strong>
              <strong class="h4 text-primary">{{ total | currency:'EGP ' }}</strong>
            </div>
            <small class="text-muted d-block mt-1">Including VAT</small>
          </div>

          <!-- Checkout Button -->
          @if (cartItems.length > 0) {
            <button class="btn btn-primary btn-lg w-100 mb-3" 
                    (click)="proceedToCheckout()"
                    [disabled]="!isAuthenticated">
              @if (!isAuthenticated) {
                <i class="fas fa-lock me-2"></i>
                Login to Checkout
              } @else {
                <i class="fas fa-shopping-bag me-2"></i>
                Proceed to Checkout
              }
            </button>
          }
          
          <a routerLink="/products" class="btn btn-outline-primary w-100">
            <i class="fas fa-arrow-left me-2"></i>
            Continue Shopping
          </a>

          <!-- Secure Payment Info -->
          <div class="mt-4 pt-3 border-top">
            <div class="d-flex align-items-center text-muted small mb-2">
              <i class="fas fa-lock text-success me-2"></i>
              <span>Secure Payment</span>
            </div>
            <div class="d-flex align-items-center text-muted small">
              <i class="fas fa-shield-alt text-primary me-2"></i>
              <span>SSL Encrypted</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>