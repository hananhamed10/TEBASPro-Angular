<div class="wishlist-container">
  <div class="container py-5">
    
    <!-- Header -->
    <div class="wishlist-header mb-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="page-title mb-2">
            <i class="fas fa-heart text-danger me-3"></i>
            My Wishlist
          </h1>
          <p class="text-muted mb-0">
            Save items you love and come back to them later
          </p>
        </div>
        
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" (click)="refreshWishlist()" [disabled]="loading">
            <i class="fas fa-sync-alt me-2" [class.fa-spin]="loading"></i>
            {{ loading ? 'Refreshing...' : 'Refresh' }}
          </button>
          
          <button class="btn btn-outline-secondary" (click)="shareWishlist()" [disabled]="isEmpty()">
            <i class="fas fa-share-alt me-2"></i>
            Share
          </button>
        </div>
      </div>
      
      <div class="wishlist-stats">
        <div class="stat-item">
          <span class="stat-label">Total Items:</span>
          <span class="stat-value">{{ getItemCount() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Available:</span>
          <span class="stat-value text-success">{{ getAvailableItemsCount() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total Value:</span>
          <span class="stat-value text-primary">${{ getTotalValue().toFixed(2) }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Avg Rating:</span>
          <span class="stat-value">
            <i class="fas fa-star text-warning"></i>
            {{ getAverageRating() }}/5
          </span>
        </div>
      </div>
    </div>

    <!-- Content with proper @if @else structure -->
    @if (loading && items.length === 0) {
      <!-- Loading State -->
      <div class="loading-spinner text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your wishlist...</p>
      </div>
    } @else if (error) {
      <!-- Error State -->
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
        <div>
          <h5 class="alert-heading mb-1">Error Loading Wishlist</h5>
          <p class="mb-0">{{ error }}</p>
        </div>
        <button class="btn btn-outline-danger ms-auto" (click)="loadWishlist()">
          <i class="fas fa-redo me-2"></i>
          Try Again
        </button>
      </div>
    } @else if (isEmpty()) {
      <!-- Empty State -->
      <div class="empty-wishlist text-center py-5">
        <div class="empty-icon mb-4">
          <i class="fas fa-heart-broken fa-4x text-muted"></i>
        </div>
        <h3 class="mb-3">Your wishlist is empty</h3>
        <p class="text-muted mb-4">Save items you love and come back to them later</p>
        <a routerLink="/products" class="btn btn-primary btn-lg">
          <i class="fas fa-shopping-bag me-2"></i>
          Browse Products
        </a>
      </div>
    } @else {
      <!-- Wishlist Items -->
      <div class="wishlist-content">
        <!-- Actions Bar -->
        <div class="wishlist-actions mb-4">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline-danger" (click)="clearAll()" [disabled]="isEmpty()">
                <i class="fas fa-trash me-2"></i>
                Clear All
              </button>
              
              <button class="btn btn-success" (click)="addAllToCart()" 
                      [disabled]="getAvailableItemsCount() === 0 || isAddingToCart">
                <i class="fas fa-shopping-cart me-2"></i>
                @if (isAddingToCart) {
                  <span>Adding...</span>
                } @else {
                  <span>Add All to Cart ({{ getAvailableItemsCount() }})</span>
                }
              </button>
              
              <button class="btn btn-outline-info" (click)="exportWishlist()">
                <i class="fas fa-download me-2"></i>
                Export
              </button>
            </div>
            
            <div class="sort-dropdown">
              <select class="form-select" (change)="sortBy($any($event.target).value)" [value]="sortOption">
                <option value="date">Sort by: Recently Added</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="name">Name: A to Z</option>
                <option value="stock">Availability</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Items Grid -->
        <div class="row">
          @for (item of items; track item.id; let i = $index) {
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="wishlist-card card h-100">
                <!-- Product Image -->
                <div class="product-image position-relative">
                  <div class="image-container" style="height: 250px; overflow: hidden;">
                    <img 
                      [src]="getProductImage(item)" 
                      [alt]="item.product?.name || 'Product image'"
                      class="card-img-top h-100"
                      loading="lazy"
                      (click)="goToProduct(item)"
                      (error)="handleImageError($event, item)"
                      style="cursor: pointer; object-fit: cover;"
                      [style.object-position]="'center'">
                  </div>
                  
                  <!-- Discount Badge -->
                  @if (calculateDiscount(item) > 0) {
                    <div class="discount-badge">
                      -{{ calculateDiscount(item) }}%
                    </div>
                  }
                  
                  <!-- Remove Button -->
                  <button class="remove-btn" (click)="removeItem(item)" title="Remove from wishlist">
                    <i class="fas fa-times"></i>
                  </button>
                  
                  <!-- Stock Badge -->
                  <div class="stock-badge" [ngClass]="getStockBadgeClass(item)">
                    {{ getStockStatus(item) }}
                  </div>
                </div>

                <!-- Card Body -->
                <div class="card-body d-flex flex-column">
                  <!-- Product Info -->
                  <h5 class="product-title mb-2" (click)="goToProduct(item)" style="cursor: pointer;">
                    {{ item.product?.name || 'Unnamed Product' }}
                  </h5>
                  
                  <p class="product-description text-muted small mb-3 flex-grow-1">
                    {{ (item.product?.description || '').substring(0, 80) }}...
                  </p>
                  
                  <!-- Price -->
                  <div class="product-price mb-3">
                    <span class="current-price fs-5 fw-bold">${{ item.product?.price?.toFixed(2) || '0.00' }}</span>
                    @if (item.product?.originalPrice && item.product.originalPrice > item.product?.price) {
                      <span class="original-price text-muted text-decoration-line-through ms-2">
                        ${{ item.product.originalPrice.toFixed(2) }}
                      </span>
                    }
                  </div>
                  
                  <!-- Rating -->
                  @if (item.product?.rating) {
                    <div class="product-rating mb-3">
                      <span class="stars">
                        @for (star of [1,2,3,4,5]; track star) {
                          <i class="fas fa-star" [ngClass]="star <= item.product.rating ? 'text-warning' : 'text-muted'"></i>
                        }
                      </span>
                      <span class="rating-value ms-2 small">({{ item.product.rating }})</span>
                    </div>
                  }
                  
                  <!-- Added Date -->
                  <div class="added-date text-muted small mb-3">
                    <i class="far fa-clock me-1"></i>
                    Added {{ formatDate(item.addedDate) }}
                  </div>
                  
                  <!-- Actions -->
                  <div class="product-actions mt-auto">
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary btn-sm flex-grow-1" 
                              (click)="addToCart(item)"
                              [disabled]="!item.product?.stock || item.product.stock === 0 || isAddingToCart"
                              [title]="item.product?.stock > 0 ? 'Add to cart' : 'Out of stock'">
                        <i class="fas fa-cart-plus me-1"></i>
                        @if (isAddingToCart) {
                          <span>Adding...</span>
                        } @else {
                          <span>Add to Cart</span>
                        }
                      </button>
                      
                      <button class="btn btn-outline-secondary btn-sm" 
                              (click)="goToProduct(item)"
                              title="View product details">
                        <i class="fas fa-eye"></i>
                      </button>
                      
                      <button class="btn btn-outline-danger btn-sm" 
                              (click)="removeItem(item)"
                              title="Remove from wishlist">
                        <i class="far fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Summary Footer -->
        <div class="wishlist-summary mt-5 pt-4 border-top">
          <div class="row">
            <div class="col-md-6">
              <h5>Wishlist Summary</h5>
              <p class="text-muted small">
                You have {{ getItemCount() }} items in your wishlist. 
                {{ getAvailableItemsCount() }} items are available for purchase.
              </p>
              <p class="text-muted small">
                Total value: <strong>${{ getTotalValue().toFixed(2) }}</strong>
              </p>
            </div>
            <div class="col-md-6 text-md-end">
              <button class="btn btn-success btn-lg" 
                      (click)="addAllToCart()"
                      [disabled]="getAvailableItemsCount() === 0 || isAddingToCart">
                <i class="fas fa-shopping-cart me-2"></i>
                @if (isAddingToCart) {
                  <span>Adding to Cart...</span>
                } @else {
                  <span>Add All Available to Cart ({{ getAvailableItemsCount() }})</span>
                }
              </button>
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>